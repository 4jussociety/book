# 물리치료/재활 일정 관리 시스템 기능 명세서
# 이 문서는 물리치료 및 재활 일정 관리 시스템(v1.1)의 아키텍처, 기능, DB, API 및 UI/UX 상세 명세를 정의합니다.

# [상세 기능명세서] 물리치료/재활 일정 관리 시스템 (v1.1)

## 1. 제품 범위 및 공통 규칙

### 1.1 범위 (Out of Scope)
- **환자용 기능**: 환자용 예약 접수 및 회원 역할 없음.
- **인증**: OAuth 로그인 없음 (ID/PW 방식만 지원).
- **알림**: 문자 자동 발송 없음 (문구 “생성/복사” 기능만 제공).
- **연동**: 외부 캘린더/EMR API 연동 없음.

### 1.2 공통 규칙
- **시간 단위**: 최소 단위 10분.
- **시간 저장**: DB는 `UTC timestamptz` (또는 ISO8601 UTC)로 저장, UI는 `Asia/Seoul`로 표시.
- **동시성 관리 (Concurrency)**:
  - 여러 직원이 동시에 수정하므로 **낙관적 락(Optimistic Locking, version)** + **409 충돌 처리**를 기본으로 함.
- **예약 상태 표준 (4개 고정)**:
  - `PENDING` (예정)
  - `COMPLETED` (완료)
  - `CANCELLED` (취소)
  - `NOSHOW` (노쇼)

### 1.3 자동 완료 기준
- **기준**: 예약 종료 시간(`end_time`) 기준.
- **동작**: 종료 시간이 현재 시간(Time Line)을 지나면 자동으로 `COMPLETED` 스타일 및 라벨 표시, 서버 상태도 반영.

## 2. 데이터베이스(DB) 상세 설계
- **RDBMS**: PostgreSQL 기준.

### 2.1 테이블 목록
- `users` (스태프)
- `patients` (환자)
- `appointments` (예약 + 잠금 통합)
- `recurring_series` (반복 예약)
- `revenue_items` (매출 항목)
- `audit_logs` (감사 로그)
- `patient_counters` (고객번호 자동 증가용)

### 2.2 Users (스태프)
| 필드명 | 타입 | 제약 | 설명 |
| :--- | :--- | :--- | :--- |
| `id` | uuid | PK | 사용자 ID |
| `username` | varchar | UNIQUE | 로그인 ID |
| `password_hash` | varchar | | 비밀번호 해시 |
| `role` | enum | | `ADMIN`, `THERAPIST`, `STAFF` (권한 동일, 분류용) |
| `name` | varchar | | 이름 |
| `color_code` | varchar | | 치료사 트랙 색상 (HEX) |
| `created_at` | timestamptz | | |
| `updated_at` | timestamptz | | |
- **Index**: `users(username)`

### 2.3 Patients (환자)
| 필드명 | 타입 | 제약 | 설명 |
| :--- | :--- | :--- | :--- |
| `id` | uuid | PK | 환자 ID |
| `patient_no` | int | UNIQUE, NOT NULL | 화면 표시용 고객번호 (#12) |
| `name` | varchar | NOT NULL | 이름 |
| `phone` | varchar | | 휴대폰 (가족 공유 가능, UNIQUE 아님) |
| `gender` | enum | | `MALE`, `FEMALE` |
| `birth_date` | date | | 생년월일 |
| `first_visit_date` | date | | 초진일 |
| `last_appointment_at` | timestamptz | | 마지막 예약 시작 시각 (갱신) |
| `created_at` | timestamptz | | |
| `updated_at` | timestamptz | | |
- **Index**: `patients(patient_no)`, `patients(name)`, `patients(phone)`

### 2.4 Patient Counters (고객번호 자동 증가)
| 필드명 | 타입 | 제약 | 설명 |
| :--- | :--- | :--- | :--- |
| `key` | varchar | PK | 구분 키 (예: default) |
| `last_patient_no` | int | NOT NULL | 마지막 할당 번호 |
- **규칙**:
  - 초진 시 번호 미입력 -> 트랜잭션 내 `last_patient_no + 1` 할당.
  - 수동 입력 시 -> `patients.patient_no` 중복 체크 (409 Conflict).

### 2.5 Recurring Series (반복 예약)
| 필드명 | 타입 | 제약 | 설명 |
| :--- | :--- | :--- | :--- |
| `id` | uuid | PK | 시리즈 ID |
| `therapist_id` | uuid | FK(users) | 트랙 주체 |
| `patient_id` | uuid | FK(patients), NULL | 환자 ID (잠금은 NULL 가능) |
| `rule` | jsonb | NOT NULL | 반복 규칙 (요일, 간격, 횟수 등) |
| `start_time_template` | time | | 시작 시간 (예: 14:00) |
| `duration_minutes` | int | | 길이 (10분 단위) |
| `end_condition` | jsonb | | `{type: 'COUNT', count: 10}` 등 |
| `created_by` | uuid | FK(users) | 생성자 |
| `created_at` | timestamptz | | |

### 2.6 Appointments (예약 + 잠금)
| 필드명 | 타입 | 제약 | 설명 |
| :--- | :--- | :--- | :--- |
| `id` | uuid | PK | 예약 ID |
| `event_type` | enum | NOT NULL | `APPOINTMENT` (예약), `BLOCK` (잠금) |
| `therapist_id` | uuid | FK(users) | 치료사 |
| `patient_id` | uuid | FK(patients), NULL | 환자 (BLOCK이면 NULL) |
| `start_time` | timestamptz | NOT NULL | 시작 시간 |
| `end_time` | timestamptz | NOT NULL | 종료 시간 |
| `status` | enum | NOT NULL | `PENDING`, `COMPLETED`, `CANCELLED`, `NOSHOW` |
| `visit_count` | int | NULL | 회차 (초진=1) |
| `note` | text | | 기록 |
| `block_title` | varchar | NULL | BLOCK 제목 |
| `block_memo` | text | NULL | BLOCK 메모 |
| `series_id` | uuid | FK(series), NULL | 반복 그룹 ID |
| `version` | int | Default 1 | 낙관적 락 버전 |
| `created_by` | uuid | FK(users) | |
| `updated_by` | uuid | FK(users) | |
| `created_at` | timestamptz | | |
| `updated_at` | timestamptz | | |
- **Index**: `(therapist_id, start_time)`, `(patient_id, start_time DESC)`, `(series_id)`, `(status, start_time)`
- **Constraint**: `therapist_id` 기준 시간 겹침 방지 (EXCLUDE 또는 API 레벨 체크).

### 2.7 Revenue Items (매출 항목)
| 필드명 | 타입 | 제약 | 설명 |
| :--- | :--- | :--- | :--- |
| `id` | uuid | PK | |
| `appointment_id` | uuid | FK(appointments) | 완료 예약 연결 |
| `item_name` | varchar | NOT NULL | 항목명 |
| `unit_price` | numeric | NOT NULL | 단가 |
| `quantity` | int | Default 1 | 수량 |
| `created_at` | timestamptz | | |
- **집계 규칙**: `status = COMPLETED` 인 건만 매출 집계.

### 2.8 Audit Logs (감사 로그)
| 필드명 | 타입 | 설명 |
| :--- | :--- | :--- |
| `id` | uuid | PK |
| `actor_user_id` | uuid | 변경자 |
| `entity_type` | varchar | `APPOINTMENT`, `PATIENT`, `SERIES` |
| `entity_id` | uuid | 대상 ID |
| `action` | varchar | `CREATE`, `UPDATE`, `DELETE`, `STATUS_CHANGE` |
| `old_data` | jsonb | 변경 전 |
| `new_data` | jsonb | 변경 후 |
| `created_at` | timestamptz | |

### 2.9 회차 반영 비즈니스 로직
- **초진**: `visit_count = 1`
- **재진**: 해당 환자의 기존 예약 중 `status IN (PENDING, COMPLETED)` && `event_type='APPOINTMENT'` 인 것들의 `MAX(visit_count) + 1`.
- **예외**: `CANCELLED`, `NOSHOW`는 회차 산정에서 제외.

## 3. API 상세 명세 (REST v1)
- **Base**: `/api/v1`
- **Auth**: `Authorization: Bearer <JWT>`

### 3.1 Auth
- `POST /auth/login`: `{username, password}` -> `{token, user}`

### 3.2 Users / Therapists
- `GET /users/me`: 내 프로필.
- `GET /therapists`: 캘린더 트랙 표시용 치료사 목록.

### 3.3 Patients
- `GET /patients`: 목록 조회 (Query: `q`, `page`, `therapistId` 등).
- `GET /patients/{id}`: 상세 조회.
- `POST /patients`: 환자 생성.
- `PATCH /patients/{id}`: 환자 수정.
- `GET /patients/search?q=...`: 재진 환자 빠른 검색.
- `GET /patients/{id}/notes`: 재진 모달 기록 히스토리 (최신순).

### 3.4 Calendar (Appointments + Blocks)
- `GET /calendar`: 주간 캘린더 로드 (예약 + 잠금).
- `POST /appointments`: 예약/잠금 생성.
  - 재진: `patientId` 포함.
  - 초진: `newPatient` 객체 포함 (트랜잭션 처리), `patientNo` 없으면 자동 할당.
  - 잠금: `eventType='BLOCK'`.
- `PATCH /appointments/{id}`: 수정 (시간, 상태, 노트 등). `version` 필수 (낙관적 락).
- `DELETE /appointments/{id}`: 삭제 (Audit Log 기록).

### 3.5 Recurring (반복)
- `POST /series`: 반복 예약 생성 (서버에서 개별 Appointment 생성).
- `PATCH /series/{id}`: 반복 수정 (`scope=THIS|ALL` 필수).
- `DELETE /series/{id}`: 반복 삭제 (`scope=THIS|ALL`).

### 3.6 SMS
- `POST /appointments/{id}/sms-preview`: 템플릿 적용된 문자 텍스트 반환 (복사 전용).

### 3.7 Stats
- `GET /stats/summary`: 주요 지표 (예약, 완료, 노쇼율 등).
- `GET /stats/revenue`: 매출 통계 (치료사별, 항목별).
- `GET /stats/export.csv`: 데이터 내보내기.

## 4. UI/UX 상세 가이드 (참조)
- 상세 UI/UX 동작은 `페이지 구성 가이드.md` 문서를 참조.
